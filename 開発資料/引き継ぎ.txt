NDSimulator 開発引き継ぎ資料（統合・整理版）

本資料は、これまでの開発経緯・修正履歴を機能別・トピック別に整理し、重複を排除した最新の仕様書です。

==================================================

プロジェクト構造と役割 ================================================== 本シミュレーターは、肥大化を防ぐためにクラス機能をMixinを用いて分割・構成している。

■ メイン実行・データ定義

main.py: エントリーポイント。JSON読み込み（再帰解析含む）、キャラクター生成、シミュレーター初期化、実行、結果表示。

models.py: データクラス定義（Skill, DamageProfile, WeaponConfig）。

buff_manager.py: バフおよびスタックの管理。add_buff は stack_amount 引数で複数スタック同時付与に対応済み。

■ シミュレーターエンジン (NikkeSimulator) engine.py で以下のMixinを継承して統合。

engine.py: メインループ (tick)、初期化、ログ出力、全体進行管理。毎フレームのDoT/HoT計算、リジェネ処理もここで行う。

engine_skills.py (SkillEngineMixin): スキル効果の判定と適用ロジック。

engine_burst.py (BurstEngineMixin): バースト状態遷移、クールダウン管理。

■ キャラクター (Character) character.py で以下のMixinを継承して統合。

character.py: 基本属性、現在HP、HoTリスト等の保持。heal メソッドの実装。

character_stats.py (CharacterStatsMixin): ステータス計算、ダメージ計算、最大HP計算、フレーム短縮計算。

character_skill.py (CharacterSkillMixin): スキル発動トリガーの判定ロジック。

character_action.py (CharacterActionMixin): 射撃、リロード、弾薬管理、状態遷移。

================================================== 2. JSONデータ記述ルール（重要）
データ読み込み時（main.py）の解析ロジックに関わる重要事項。

【基本ルール】

kwargs の必須性: スキル効果のパラメータ（value, duration, buff_type等）は、必ず kwargs ディクショナリの中に記述すること。

ターゲット条件の記述: 条件記述は {"type": "class", "value": "Supporter"} のような形式に統一すること（プログラム側でサポート）。

【レベル依存パラメータの自動展開 (_list)】

命名規則: キー名の末尾が _list で終わるもの（例: value_list, multiplier_list）は、スキルレベルに応じた値を自動抽出して展開する。

逆に、レベル依存でない固定リストデータには _list を付けてはならない。

再帰的展開: main.py の改修により、ネストされた辞書やリスト（例: delayed_action 内の sub_effect 内の stages）の深層にある _list も全て探索・変換される。

優先順位: 同一階層に value と value_list がある場合、リストから算出された値が優先（上書き）される。

ammo_charge/refill_ammo の特例: value_list で指定した場合、自動的に rate としてマッピングされる救済ロジックが存在する。

【ターゲット判定のスコープ】

condition: 敵の状態（not_has_tag等）やグローバルな状況（simulation_flag等）の判定。

target_condition: スキル対象（Self含む）個人の状態判定（class, element, has_barrier, highest_atk 等）。

味方や自分自身のタグ所持判定もこちらで行うこと。

複合条件（例：「防御型」かつ「攻撃力が高い2機」）も記述可能。

【ダミースキル】

効果未定のスキルは "trigger_type": "dummy" とすることで、システム上で無視され発動しない。

================================================== 3. コアロジック仕様
【HP管理と回復システム】

現在HP (current_hp): 初期値は最大HP。変動をリアルタイム管理。

heal メソッド: 全ての回復処理を集約。

計算式: 基本回復量 × (1 + 受ける回復量UPバフ)

超過回復: バフ max_hp_overflow がある場合のみ、最大HPを超えて回復可能。

トリガー: 回復発生時に on_receive_heal を発火。

最大HPバフの同期:

"kwargs": { "buff_type": "max_hp_rate", "update_current_hp": true } と記述すると、最大HPが増加した分だけ、現在HPも加算される（現在HP割合の維持ではないが、実数値として減らない挙動）。

【ダメージ計算】

特殊スキルダメージ: profile に "is_special_skill_damage": true を指定すると、バフ special_skill_dmg_buff が別枠乗算として計算される。

ステータス参照 (scale_by_caster_stats):

デフォルトでは「基礎ステータス (base)」を参照する仕様に変更済み。

バフ込み値を参照したい場合は "stat_type": "finally" を指定する。

参照先は target_stat: "atk" (デフォルト) または "max_hp" を指定可能。

【時間短縮計算】

リロード・チャージ時間は、「割合短縮（乗算）」と「固定値短縮（減算）」を組み合わせた calculate_reduced_frame を使用。

攻撃速度（Attack Speed）には固定値短縮は適用されない。

【MG武器の仕様】

warmup_table は「辞書のリスト [{'start':.., 'interval':..}]」形式で扱う。JSONが配列の配列の場合は WeaponConfig 初期化時に正規化される。

================================================== 4. スキル効果・トリガーの実装詳細
【バースト関連】

トリガー推奨: 自身のバースト発動に連動する効果（タグ付与直後の判定など）は、on_use_burst_skill を使用すること。

on_burst_enter は状態遷移後のため、タグ付与タイミングと判定が噛み合わないリスクがある。

再突入 (reenter_burst_stage): バースト段階を戻す・維持する効果（ティア、ルージュ等）。

CT短縮: JSONに cooldown_time 指定があればそれを優先。なければデフォルト（I/II:20秒, III:40秒）。

【実装済み効果タイプ (effect_type)】

regenerate: リジェネ。発動時の回復量がスナップショットされ、指定間隔で持続回復。

shield: バリア付与。tag 指定で共有/個別を区別可能。条件判定には has_barrier を使用。

increase_current_stack_count: スタック数を直接増減させる。

set_stack: スタック数を特定の値に固定する。

decrease_debuff_stack_count: デバフのスタックを解除（減少）させる。

refill_ammo_fixed: 固定数リロード。

activate_flag: フラグを立てる（has_flag で判定）。

delayed_action: 指定時間後にサブ効果を発動。

【特殊なバフ・デバフ】

drain: 攻撃ダメージの一定割合を回復するバフ。

stun: 気絶。射撃不可になり、バースト発動候補からも除外される。

【トリガー (trigger_type) の特記事項】

回数累積型 (pellet_hit, critical_hit): 1フレームに複数回条件を満たした場合、その回数分だけ発動する（(現在値 // 条件) - (前回値 // 条件) 判定）。

stack_count: スタックが増加した瞬間のみ判定される。

variable_interval: スタック数に応じて発動間隔が可変するトリガー。

interval_after_burst_end: 自身が発動したフルバースト終了時を起点とする時間トリガー。

full_charge_count: フルチャージ攻撃回数をトリガーとする。

================================================== 5. シミュレーション制御
汎用フラグ (simulation_flag):

main.py で sim.special_mode = True のように変数をセットし、JSONの condition で "simulation_flag": "special_mode" と指定することで、特定モード（部位破壊あり/なし等）の挙動を切り替え可能。

ログ出力:

各キャラのログに加え、logs/hp_log.csv に1秒ごとのHP推移（現在HP, 最大HP, 割合）が出力される。

================================================== 6. 最新の更新・変更点 (Updates)

【バフ管理 (buff_manager.py)】
タグの複数指定対応:
  バフ・デバフの "tag" 指定において、リスト形式（例: ["debuff", "burn"]）での記述に対応。
  これにより、「デバフ」かつ「燃焼」といった複合属性を持たせることが可能になり、
  cleanse_debuff("debuff") でも remove_buffs_by_tag("burn") でも解除対象となる。
  ※ 内部判定ロジック（has_active_tag, remove_buffs_by_tag 等）をリスト包含判定に対応済み。

  【バグ修正 (Critical)】
1. キャラクター生成時のスキルリスト共有バグ修正
   Pythonの参照渡し仕様により、メイン処理（main.py）で読み込んだJSONデータをそのままCharacterに渡すと、
   全キャラクター（特にダミー）が同じスキルリスト・状態変数を共有してしまう致命的なバグを修正。
   対策: キャラクター生成時（Characterクラス初期化時）に `copy.deepcopy()` を使用し、データを完全複製するように変更済み。

2. DoT（持続ダメージ）管理構造の修正
   DoTデータの管理が辞書（dict）形式であるにも関わらず、一部処理でリスト（append）として扱おうとしていたバグを修正。
   また、変数名の不一致（s_name / stack_name）によるエラーも解消済み。

【機能追加 (New Features)】
1. 効果時間の延長機能 (Extend)
   既存のバフやDoTの効果時間を、上書きではなく「延長（現在残り時間 + 追加時間）」できる機能を追加。
   JSON記述: "is_extend": true を指定。
   検索キー: "tag" が一致する効果を探して延長する。スキル名が異なっていてもタグが合致すれば延長可能。

2. リロード完了トリガー (reload_complete)
   リロードが完了した瞬間に発動するトリガーを追加。
   trigger_type: "reload_complete"
   用途: 「リロード完了後の初弾のみ強化（硫酸弾）」などの実装に使用。

1. リロード・攻撃速度計算の仕様変更 (Update)
内容: calculate_reduced_frame（リロード・チャージ短縮）および calculate_reduced_frame_attack（攻撃速度）の計算において、小数点以下の処理を 「四捨五入 (round_half_up)」 に統一しました。

理由: 微小なバフ（例: 3F間隔の武器に数%のバフ）で意図せずフレーム短縮が発生するのを防ぐため。

記述場所: 「3. コアロジック仕様 - 時間短縮計算」セクション。

2. スタック増加処理の修正 (Fix)
内容: increase_current_stack_count 効果において、stack_name を明示的に指定した場合、active_stacks（スタックバフ）を正しく操作するように buff_manager.py と engine_skills.py を修正しました。

挙動: 名前指定時はそのスタックのみ増加、名前なし時は「通常のバフを除く、全てのスタックバフ」が増加します。

記述場所: 「4. スキル効果・トリガーの実装詳細」セクション。

3. 遮蔽物HP回復の実装 (New Feature)
内容: 遮蔽物のHPを回復する機能を追加しました。

Effect Type: cover_heal

Trigger: on_receive_cover_heal（回復を受けた時に発動）

Method: Character.recover_cover_hp

JSON仕様: value が 2.0 (200%) 以下なら「割合回復（最大HP×value）」、それより大きければ「固定値回復」とみなす簡易判定ロジックを実装。

記述場所: 「6. 最新の更新・変更点」セクション。

4. 高速化・キャッシュの実装 (Optimization)
内容: buff_manager.py に計算結果のキャッシュ機能を追加しました。

仕様: フレーム単位でキャッシュを管理。同一フレーム内でのステータス再計算をスキップし、フレーム変更時にキャッシュをクリア（期限切れバフの掃除を実行）します。

記述場所: 「6. 最新の更新・変更点」または「1. プロジェクト構造 - buff_manager.py」セクション。

5. 「回数制限付きバフ」の定義ルール (Rule)
内容: 「n回攻撃したら消える」バフを定義する場合、shot_duration を設定し、duration（秒数）は設定しない（または0にする） こと。

理由: 現在の仕様では duration が設定されていると、回数を使い切っても時間が残っていればバフが消滅しないため。

記述場所: 「2. JSONデータ記述ルール」セクション。

6. 確率発動スキルの記述 (Rule)
内容: 攻撃時に確率で発動する場合、kwargs に "probability": 10 (10%の意味) を記述し、trigger_type は shot_count、trigger_value は 1 とする。

記述場所: 「2. JSONデータ記述ルール」セクション。

7. バーストCTの永続短縮機能 (New Feature)
   内容: バースト発動時に決定される「基礎クールタイム」自体を短縮するバフを追加。
   Buff Type: burst_cooldown_reduction
   挙動: キャラクターがバーストを発動した際、このバフの合計値（秒数）を最大CT（40秒など）から減算して、次回のCTを設定する。
         ※ 既存の cooldown_reduction（現在CTの短縮）とは別枠。

8. スタック増加無効化フラグの実装 (New Feature)
   内容: スタックバフ定義時に "disable_stack_increase": true を指定することで、
         「スタック増減 (increase_current_stack_count)」スキルの対象外にできる機能を追加。
   挙動:
         - 増加スキル側で stack_name を指定していない（全体増加）場合 -> 無視される（増えない）。
         - 増加スキル側で stack_name を明示的に指定している場合 -> フラグに関わらず増える（特定指名なので優先）。
   記述場所: 「4. 特殊機能・トリガー操作」セクション。

9. アクション速度の固定・バフ一時無効化機能 (New Feature)
   内容: リロード、チャージ、攻撃速度計算において、特定のタグが付与されている間、バフ補正を無視する機能を追加。
   Tags: 
     - ignore_reload_speed_buffs
     - ignore_charge_speed_buffs
     - ignore_attack_speed_buffs
   ホワイトリスト機能:
     バフ定義時 (kwargs) に "allow_tags": ["my_buff"] のように指定することで、
     無効化モード中であっても、指定タグを持つバフの効果だけは適用させることが可能。
     これにより、「リロード速度を固定にするが、自分のスキルによる短縮だけは有効」といった挙動が実現できる。
   記述場所: 「2. 武器・アクション挙動系」セクション。

   【直近の修正・実装項目】（YYYY/MM/DD 更新）

1. バグ修正・仕様変更
   - MG（マシンガン）の射撃レート維持: 武器変更時や復帰時に減衰レートを正しく再計算し、レートがリセットされないよう修正。
   - MGのウォームアップ計算: warmup_table が連番（1, 2...）で始まる場合、Durationではなく「弾数インデックス」として解釈する自動判定を追加。
   - デバフ計算の適正化: taken_dmg_debuff, def_debuff 計算時に、攻撃者自身（Self）のデバフを参照していたバグを修正。デバフは「敵（Enemy）に付与し、敵のデバフを参照する」仕様に統一。
   - スタック増加の重複ガード: increase_current_stack_count が allies 対象時にループして過剰に増加する問題に対し、同一フレーム・同一対象・同一スタック名での処理を1回に制限するガード処理を実装。

2. 機能追加
   - HP基準防御デバフ: 固定値で防御を下げる def_debuff_fixed を実装。0以下にはならない仕様。
   - スケーリング補正: JSONの value を維持したまま計算倍率を変えられる scaling_factor を実装。
   - 回数限定スキル: 戦闘中にN回しか発動しない max_trigger_count を実装。
   - ターゲット条件: 元のチャージ時間が長い順に選択する highest_base_charge_time を実装。