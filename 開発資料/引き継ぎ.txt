NDSimulator 開発引き継ぎ資料（統合・整理版）

本資料は、これまでの開発経緯・修正履歴を機能別・トピック別に整理し、重複を排除した最新の仕様書です。

==================================================

プロジェクト構造と役割 ================================================== 本シミュレーターは、肥大化を防ぐためにクラス機能をMixinを用いて分割・構成している。

■ メイン実行・データ定義

main.py: エントリーポイント。JSON読み込み（再帰解析含む）、キャラクター生成、シミュレーター初期化、実行、結果表示。

models.py: データクラス定義（Skill, DamageProfile, WeaponConfig）。

buff_manager.py: バフおよびスタックの管理。add_buff は stack_amount 引数で複数スタック同時付与に対応済み。

■ シミュレーターエンジン (NikkeSimulator) engine.py で以下のMixinを継承して統合。

engine.py: メインループ (tick)、初期化、ログ出力、全体進行管理。毎フレームのDoT/HoT計算、リジェネ処理もここで行う。

engine_skills.py (SkillEngineMixin): スキル効果の判定と適用ロジック。

engine_burst.py (BurstEngineMixin): バースト状態遷移、クールダウン管理。

■ キャラクター (Character) character.py で以下のMixinを継承して統合。

character.py: 基本属性、現在HP、HoTリスト等の保持。heal メソッドの実装。

character_stats.py (CharacterStatsMixin): ステータス計算、ダメージ計算、最大HP計算、フレーム短縮計算。

character_skill.py (CharacterSkillMixin): スキル発動トリガーの判定ロジック。

character_action.py (CharacterActionMixin): 射撃、リロード、弾薬管理、状態遷移。

================================================== 2. JSONデータ記述ルール（重要）
データ読み込み時（main.py）の解析ロジックに関わる重要事項。

【基本ルール】

kwargs の必須性: スキル効果のパラメータ（value, duration, buff_type等）は、必ず kwargs ディクショナリの中に記述すること。

ターゲット条件の記述: 条件記述は {"type": "class", "value": "Supporter"} のような形式に統一すること（プログラム側でサポート）。

【レベル依存パラメータの自動展開 (_list)】

命名規則: キー名の末尾が _list で終わるもの（例: value_list, multiplier_list）は、スキルレベルに応じた値を自動抽出して展開する。

逆に、レベル依存でない固定リストデータには _list を付けてはならない。

再帰的展開: main.py の改修により、ネストされた辞書やリスト（例: delayed_action 内の sub_effect 内の stages）の深層にある _list も全て探索・変換される。

優先順位: 同一階層に value と value_list がある場合、リストから算出された値が優先（上書き）される。

ammo_charge/refill_ammo の特例: value_list で指定した場合、自動的に rate としてマッピングされる救済ロジックが存在する。

【ターゲット判定のスコープ】

condition: 敵の状態（not_has_tag等）やグローバルな状況（simulation_flag等）の判定。

target_condition: スキル対象（Self含む）個人の状態判定（class, element, has_barrier, highest_atk 等）。

味方や自分自身のタグ所持判定もこちらで行うこと。

複合条件（例：「防御型」かつ「攻撃力が高い2機」）も記述可能。

【ダミースキル】

効果未定のスキルは "trigger_type": "dummy" とすることで、システム上で無視され発動しない。

================================================== 3. コアロジック仕様
【HP管理と回復システム】

現在HP (current_hp): 初期値は最大HP。変動をリアルタイム管理。

heal メソッド: 全ての回復処理を集約。

計算式: 基本回復量 × (1 + 受ける回復量UPバフ)

超過回復: バフ max_hp_overflow がある場合のみ、最大HPを超えて回復可能。

トリガー: 回復発生時に on_receive_heal を発火。

最大HPバフの同期:

"kwargs": { "buff_type": "max_hp_rate", "update_current_hp": true } と記述すると、最大HPが増加した分だけ、現在HPも加算される（現在HP割合の維持ではないが、実数値として減らない挙動）。

【ダメージ計算】

特殊スキルダメージ: profile に "is_special_skill_damage": true を指定すると、バフ special_skill_dmg_buff が別枠乗算として計算される。

ステータス参照 (scale_by_caster_stats):

デフォルトでは「基礎ステータス (base)」を参照する仕様に変更済み。

バフ込み値を参照したい場合は "stat_type": "finally" を指定する。

参照先は target_stat: "atk" (デフォルト) または "max_hp" を指定可能。

【時間短縮計算】

リロード・チャージ時間は、「割合短縮（乗算）」と「固定値短縮（減算）」を組み合わせた calculate_reduced_frame を使用。

攻撃速度（Attack Speed）には固定値短縮は適用されない。

【MG武器の仕様】

warmup_table は「辞書のリスト [{'start':.., 'interval':..}]」形式で扱う。JSONが配列の配列の場合は WeaponConfig 初期化時に正規化される。

================================================== 4. スキル効果・トリガーの実装詳細
【バースト関連】

トリガー推奨: 自身のバースト発動に連動する効果（タグ付与直後の判定など）は、on_use_burst_skill を使用すること。

on_burst_enter は状態遷移後のため、タグ付与タイミングと判定が噛み合わないリスクがある。

再突入 (reenter_burst_stage): バースト段階を戻す・維持する効果（ティア、ルージュ等）。

CT短縮: JSONに cooldown_time 指定があればそれを優先。なければデフォルト（I/II:20秒, III:40秒）。

【実装済み効果タイプ (effect_type)】

regenerate: リジェネ。発動時の回復量がスナップショットされ、指定間隔で持続回復。

shield: バリア付与。tag 指定で共有/個別を区別可能。条件判定には has_barrier を使用。

increase_current_stack_count: スタック数を直接増減させる。

set_stack: スタック数を特定の値に固定する。

decrease_debuff_stack_count: デバフのスタックを解除（減少）させる。

refill_ammo_fixed: 固定数リロード。

activate_flag: フラグを立てる（has_flag で判定）。

delayed_action: 指定時間後にサブ効果を発動。

【特殊なバフ・デバフ】

drain: 攻撃ダメージの一定割合を回復するバフ。

stun: 気絶。射撃不可になり、バースト発動候補からも除外される。

【トリガー (trigger_type) の特記事項】

回数累積型 (pellet_hit, critical_hit): 1フレームに複数回条件を満たした場合、その回数分だけ発動する（(現在値 // 条件) - (前回値 // 条件) 判定）。

stack_count: スタックが増加した瞬間のみ判定される。

variable_interval: スタック数に応じて発動間隔が可変するトリガー。

interval_after_burst_end: 自身が発動したフルバースト終了時を起点とする時間トリガー。

full_charge_count: フルチャージ攻撃回数をトリガーとする。

================================================== 5. シミュレーション制御
汎用フラグ (simulation_flag):

main.py で sim.special_mode = True のように変数をセットし、JSONの condition で "simulation_flag": "special_mode" と指定することで、特定モード（部位破壊あり/なし等）の挙動を切り替え可能。

ログ出力:

各キャラのログに加え、logs/hp_log.csv に1秒ごとのHP推移（現在HP, 最大HP, 割合）が出力される。